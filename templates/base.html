<!-- This is the base template for the application. It contains the basic structure of the application,
    including the navbar, grid layout, and the search bar. -->
<!-- The base template also includes the necessary scripts and stylesheets for the application. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>badgerpedia</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-deferred@1"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='badger.ico') }}">
</head>
<body>
    <div class="navbar"><button class="home-button" onclick="goBack()">badgerpedia.</button></div>

    <div class="grid">
        <div class="subgrid sub-1">
            <div class="search">
                <div class="searchBlock"><i data-feather="search" class="search-icon"></i></div>
                <div class="searchBlock"><input type="text" class="searchbar" hx-get="/search" hx-trigger="keyup delay:100ms" hx-target="#search_results" placeholder="Search for a class code..." name="q" autocomplete="off"></div>
                <button id="menuButton"><i data-feather="menu" class="search-icon-2"></i></button>
            </div>
            <div class="credits">
                <p class="filterTitle"><b>Credits</b></p>
                <div class="multi-select" id="multi-select-credits">
                    <div class="select-box" onclick="toggleOptions('multi-select-credits')">
                        <div class="selected-options" id="selected-credits"></div>
                        <span class="placeholder">Select Credits</span>
                    </div>
                    <div class="options">
                        <div class="option" data-value="1" onclick="toggleSelection(this, 'multi-select-credits', '1')">1 Credit</div>
                        <div class="option" data-value="2" onclick="toggleSelection(this, 'multi-select-credits', '2')">2 Credits</div>
                        <div class="option" data-value="3" onclick="toggleSelection(this, 'multi-select-credits', '3')">3 Credits</div>
                        <div class="option" data-value="4" onclick="toggleSelection(this, 'multi-select-credits', '4')">4 Credits</div>
                        <div class="option" data-value="5" onclick="toggleSelection(this, 'multi-select-credits', '5')">5 Credits</div>
                        <div class="option" data-value="6" onclick="toggleSelection(this, 'multi-select-credits', '6')">6 Credits</div>
                    </div>
                </div>
            </div>
            <div class="breadths">
                <p class="filterTitle"><b>Breadths</b></p>
                <div class="multi-select" id="multi-select-breadths">
                    <div class="select-box" onclick="toggleOptions('multi-select-breadths')">
                        <div class="selected-options" id="selected-breadths"></div>
                        <span class="placeholder">Select Breadths</span>
                    </div>
                    <div class="options">
                        <div class="option" data-value="BIO" onclick="toggleSelection(this, 'multi-select-breadths', 'BIO')">Biological Sciences</div>
                        <div class="option" data-value="HUM" onclick="toggleSelection(this, 'multi-select-breadths', 'HUM')">Humanities</div>
                        <div class="option" data-value="LIT" onclick="toggleSelection(this, 'multi-select-breadths', 'LIT')">Literature</div>
                        <div class="option" data-value="PHY" onclick="toggleSelection(this, 'multi-select-breadths', 'PHY')">Physical Sciences</div>
                        <div class="option" data-value="SOC" onclick="toggleSelection(this, 'multi-select-breadths', 'SOC')">Social Sciences</div>
                    </div>
                </div>
            </div>
            <div class="reqs">
                <p class="filterTitle"><b>Requirements</b></p>
                <div class="multi-select" id="multi-select-requirements">
                    <div class="select-box" onclick="toggleOptions('multi-select-requirements')">
                        <div class="selected-options" id="selected-requirements"></div>
                        <span class="placeholder">Select Requirements</span>
                    </div>
                    <div class="options">
                        <div class="option" data-value="ETHNIC" onclick="toggleSelection(this, 'multi-select-requirements', 'ETHNIC')">Ethnic Studies</div>
                        <div class="option" data-value="L&S" onclick="toggleSelection(this, 'multi-select-requirements', 'L&S')">L&S Requirement</div>
                        <div class="option" data-value="HONORS" onclick="toggleSelection(this, 'multi-select-requirements', 'HONORS')">Honors</div>
                        <div class="option" data-value="WORKPLACE" onclick="toggleSelection(this, 'multi-select-requirements', 'WORKPLACE')">Workplace Credit</div>
                        <div class="option" data-value="FOREIGN" onclick="toggleSelection(this, 'multi-select-requirements', 'FOREIGN')">Foreign Language</div>
                    </div>
                </div>
            </div>
            <div class="genEds">
                <p class="filterTitle"><b>General Education</b></p>
                <div class="multi-select" id="multi-select-genEd">
                    <div class="select-box" onclick="toggleOptions('multi-select-genEd')">
                        <div class="selected-options" id="selected-genEd"></div>
                        <span class="placeholder">Select Designations</span>
                    </div>
                    <div class="options">
                        <div class="option" data-value="COMM A" onclick="toggleSelection(this, 'multi-select-genEd', 'COMM A')">COMM A</div>
                        <div class="option" data-value="COMM B" onclick="toggleSelection(this, 'multi-select-genEd', 'COMM B')">COMM B</div>
                        <div class="option" data-value="QR-A" onclick="toggleSelection(this, 'multi-select-genEd', 'QR-A')">QR-A</div>
                        <div class="option" data-value="QR-B" onclick="toggleSelection(this, 'multi-select-genEd', 'QR-B')">QR-B</div>
                    </div>
                </div>
            </div>
            <div class="classlvl">
                <p class="filterTitle"><b>Class Level</b></p>
                <div class="multi-select" id="multi-select-classlevel">
                    <div class="select-box" onclick="toggleOptions('multi-select-classlevel')">
                        <div class="selected-options" id="selected-classlevel"></div>
                        <span class="placeholder">Select Class Level</span>
                    </div>
                    <div class="options">
                        <div class="option" data-value="ELEM" onclick="toggleSelection(this, 'multi-select-classlevel', 'ELEM')">Elementary</div>
                        <div class="option" data-value="INTER" onclick="toggleSelection(this, 'multi-select-classlevel', 'INTER')">Intermediate</div>
                        <div class="option" data-value="ADV" onclick="toggleSelection(this, 'multi-select-classlevel', 'ADV')">Advanced</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="subgrid sub-2">
        <div class="results">
                <div id="search_results"></div>
        </div>
        </div>

        <div class="subgrid sub-3">
            {% if data is not defined %}
            <div id="class_info">
                <div class="info">
                </div>
            </div>
            {% else %}
            <div id="class_info">
                <div class="info">
                    <div class="classTitle">{{ data[0][0] }}</div>
                    <div class="className">{{ data[0][1] }}</div>
                    <div class="className" style="color: #8a8a8a;">Average Grade:
                        <span>
                            {% if data[0][26] == "A " %}
                            <span style="color: #04dd78; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "AB" %}
                            <span style="color: #04dd78; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "B " %}
                            <span style="color: #cfcb4e; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "BC" %}
                            <span style="color: #cfcb4e; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "C " %}
                            <span style="color: #ff930f; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "D " %}
                            <span style="color: #ff3333; font-weight: 600;">{{ data[0][26] }}</span>
                            {% elif data[0][26] == "F " %}
                            <span style="color: #ff3333; font-weight: 600;">{{ data[0][26] }}</span>
                            {% else %}
                            {{ data[0][26] }}
                            {% endif %}
                        </span>

                        <button onClick="showChart()" class="chartButton"><i id="toggleIcon" data-feather="chevron-right" style="color: #2988ee; height: 1.1rem;"></i></button>

                    </div>
                    <div class="className" style="color: #8a8a8a;">Enrolled:
                    {% if capacity[1] != 0 %}
                    {% if capacity[0] == 0 and capacity[1] == 1 %}
                    <span style="color: #ff1b1b">N/A</span>
                    {% elif capacity[0]/capacity[1] > 0.9 %}
                    <span style="color: #ff1b1b">{{capacity[0]}}/{{capacity[1]}}</span>
                    {% elif capacity[0]/capacity[1] > 0.5 %}
                    <span style="color: #ff930f">{{capacity[0]}}/{{capacity[1]}}</span>
                    {% else %}
                    <span style="color: #04dd78">{{capacity[0]}}/{{capacity[1]}}</span>
                    {% endif %}
                    {% else %}
                    <span style="color: #ff1b1b">N/A</span>
                    {% endif %}
                    </div>
                    <div class="classAttributes">
                        <div class="classCredits"><i data-feather="check-circle" style="color: #00c889"></i>&nbsp;
                            {% if data[0][15] == data[0][16] %}
                            {{ data[0][15] }} Credits
                            {% else %}
                            {{ data[0][15] }}-{{ data[0][16] }} Credits
                            {% endif %}
                        </div>
                        <div class="repeatable"><i data-feather="repeat" style="color: #ff1b1b"></i>&nbsp;
                            {% if data[0][4] == "1" %}
                            Repeatable for Credit
                            {% elif data[0][4] == "2" %}
                            Repeatable 2x for Credit
                            {% elif data[0][4] == "3" %}
                            Repeatable 3x for Credit
                            {% elif data[0][4] == "4" %}
                            Repeatable 4x for Credit
                            {% elif data[0][4] == "5" %}
                            Repeatable 5x for Credit
                            {% elif data[0][4] == "6" %}
                            Repeatable 6x for Credit
                            {% else %}
                            Not Repeatable
                            {% endif %}
                        </div>
                        <div class="classLevel"><i data-feather="bar-chart" style="color: #15d3f4"></i>&nbsp;
                            {% if data[0][6] == 1 %}
                            Elementary
                            {% elif data[0][6] == 2 %}
                            Intermediate
                            {% elif data[0][6] == 3 %}
                            Advanced
                            {% elif data[0][6] == 0 %}
                            No Level
                            {% else %}
                            {{ data[0][6] }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="classDescription">{{ data[0][2] }}</div>
                    <div class="classDescription"><b>Prerequisites</b></div>
                    <div class="classDescription">{{ data[0][3] }}</div>

                    <div class="gradeChart">
                        <canvas id="gradeChart" style="display: none;"></canvas>
                    </div>

                    <div class="className classTimeTitle" style="color: #fff"><b>Class Times -- {{term}}</b></div>
                <div class="classTimesContainer">
                    <table class="classTimes">
                        <tr>
                            <th class="section">Section</th>
                            <th class="times">Times</th>
                            <th class="location">Location</th>
                            <th class="instructor">Instructor</th>
                            <th class="enrolled">Enrolled</th>
                            <th class="waitlist">Waitlist</th>
                        </tr>
                        {% for time in times %}
                        {% if time['type'] == 'LEC' %}
                        <tr>
                            {% if time['capacity'] - time['currentlyEnrolled'] < 1 %}
                            <td class="section" style="background-color: #ff5a5a; color: black;">{{ time['type'] }}&nbsp;{{ time['sectionNumber'] }}</td>
                            {% else %}
                            <td class="section" style="background-color: #04dd78; color: black;">{{ time['type'] }}&nbsp;{{ time['sectionNumber'] }}</td>
                            {% endif %}
                            <td class="times">{{ time['meetingDays'] }}&nbsp;{{ time['meetingTimes'][0] }} - {{ time['meetingTimes'][1] }}</td>
                            <td class="location">{{ time['location'][0] }}&nbsp;{{ time['location'][1] }}</td>
                            <td class="instructor">{{ time['instructor'] }}</td>
                            {% if time['capacity'] - time['currentlyEnrolled'] < 1 %}
                            <td class="enrolled" style="color: #ff5a5a">{{ time['currentlyEnrolled'] }} / {{ time['capacity'] }}</td>
                            {% else %}
                            <td class="enrolled" style="color: #04dd78;">{{ time['currentlyEnrolled'] }} / {{ time['capacity'] }}</td>
                            {% endif %}
                            <td class="waitlist">{{ time['waitlistCurrentSize'] }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td>{{ time['type'] }}&nbsp;{{ time['sectionNumber'] }}</td>
                            <td>{{ time['meetingDays'] }}&nbsp;{{ time['meetingTimes'][0] }} - {{ time['meetingTimes'][1] }}</td>
                            <td>{{ time['location'][0] }}&nbsp;{{ time['location'][1] }}</td>
                            <td>{{ time['instructor'] }}</td>
                            {% if time['capacity'] - time['currentlyEnrolled'] < 1 %}
                            <td style="color: #ff5a5a">{{ time['currentlyEnrolled'] }} / {{ time['capacity'] }}</td>
                            {% else %}
                            <td style="color: #04dd78;">{{ time['currentlyEnrolled'] }} / {{ time['capacity'] }}</td>
                            {% endif %}
                            <td>{{ time['waitlistCurrentSize'] }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </table>
                </div>




                    <div class="enrollmentData"></div>

                </div>
                    <script>
                        function showChart() {
                            var x = document.getElementById("gradeChart");
                            var y = document.getElementById("toggleIcon");
                            var z = document.getElementsByClassName("gradeChart")[0];
                            if (x.style.display === "none" || x.style.display === "") {
                                x.style.display = "block";
                                y.setAttribute("data-feather", "chevron-down");
                                feather.replace({ class: 'foo bar', 'stroke-width': 3, 'height': 15 });

                            } else {
                                x.style.display = "none";
                                y.setAttribute("data-feather", "chevron-right");
                                feather.replace({ class: 'foo bar', 'stroke-width': 3, 'height': 15 });
                            }
                        }
                    </script>
                    <script>
                        var ctx = document.getElementById('gradeChart').getContext('2d');
                        Chart.register(ChartDataLabels);
                        var myChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['A', 'AB', 'B', 'BC', 'C', 'D', 'F'],
                                datasets: [{
                                    data: [{{ data[0][19] }}, {{ data[0][20] }}, {{ data[0][21] }}, {{ data[0][22] }}, {{ data[0][23] }}, {{ data[0][24] }}, {{ data[0][25]}}],
                                    backgroundColor: [
                                    "rgb(47,238,168)", "rgb(80,199,140)", "rgb(112,159,113)", "rgb(145,120,85)", "rgb(177,81,57)", "rgb(210,41,30)", "rgb(242,2,2)",
                                    ],
                                datalabels: {
                                    labels: {
                                        name: {
                                            align: 'center',
                                            font: {size: 16},
                                            borderColor: 'black',
                                            borderWidth: 2,
                                            borderRadius: 25,
                                            padding: 7
                                        }
                                    },
                                }
                            }],
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                borderColor: '#212121',
                                hoverBorderColor: '#fff',
                                color: '#fff',
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    datalabels: {
                                        color: 'black',
                                        font: {
                                            weight: 'bold',
                                        },
                                        offset: 0,
                                        padding: 0,
                                        formatter: function(value, ctx) {
                                            var dataset = ctx.chart.data.datasets[ctx.datasetIndex];
                                            var total = dataset.data.reduce((accumulator, currentValue) => accumulator + currentValue, 0);
                                            var percentage = Math.round((value / total) * 100);
                                            if (percentage > 5) {
                                                return ctx.chart.data.labels[ctx.dataIndex];
                                            } else {
                                                return null; // Hides the label
                                            }
                                        },
                                    },

                                }
                            }
                        });
                        feather.replace({ class: 'foo bar', 'stroke-width': 3, 'height': 15 });
                    </script>
            </div>
            {% endif %}
        </div>
    </div>
</body>



<script>
feather.replace();
</script>
<script>
function toggleOptions(id) {
    document.querySelector(`#${id} .options`).classList.toggle('active');
}

function toggleSelection(optionElement, id, value) {
    optionElement.classList.toggle('selected');
    let selectedOptionsContainer = document.getElementById(`selected-${id.split('-')[2]}`);
    let selectedValues = Array.from(selectedOptionsContainer.children).map(child => child.getAttribute('data-value'));

    if (selectedValues.includes(value)) {
        let elementToRemove = selectedOptionsContainer.querySelector(`[data-value="${value}"]`);
        selectedOptionsContainer.removeChild(elementToRemove);
    } else {
        let span = document.createElement('span');
        span.classList.add('selected-option');
        span.setAttribute('data-value', value);
        span.textContent = value;
        let deleteIcon = document.createElement('span');
        deleteIcon.classList.add('delete-option');
        deleteIcon.textContent = '✕';
        deleteIcon.onclick = function() {
            removeSelection(span, id, value);
        };
        span.appendChild(deleteIcon);
        selectedOptionsContainer.appendChild(span);
    }

    updatePlaceholder(id);
    sendSelectionsToServer(id);
}

function removeSelection(span, id, value) {
    span.parentNode.removeChild(span);
    let optionElement = document.querySelector(`#${id} .options .option[data-value="${value}"]`);
    optionElement.classList.remove('selected');
    updatePlaceholder(id);
    sendSelectionsToServer(id);
}

function updatePlaceholder(id) {
    let selectedOptionsContainer = document.querySelector(`#${id} .selected-options`);
    let placeholder = document.querySelector(`#${id} .select-box .placeholder`);
    if (selectedOptionsContainer.children.length > 0) {
        placeholder.style.display = 'none';
    } else {
        placeholder.style.display = 'block';
    }
}

function sendSelectionsToServer(id) {
    let selectedOptionsContainer = document.querySelector(`#${id} .selected-options`);
    let selectedValues = Array.from(selectedOptionsContainer.children).map(child => child.getAttribute('data-value'));
    console.log("aoifjaoijf")
    let queryString = selectedValues.map(value => `values=${encodeURIComponent(value)}`).join('&');
    fetch(`/filter_${id.split('-')[2]}?${queryString}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('search_results').innerHTML = html;
    })
    .catch((error) => {
        console.error('Error:', error);
    });
}

document.addEventListener('click', function(event) {
    if (!event.target.closest('.multi-select')) {
        document.querySelectorAll('.multi-select .options').forEach(function(element) {
            element.classList.remove('active');
        });
    }
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const menuButton = document.getElementById('menuButton');
    const credits = document.querySelector('.credits');
    const breadths = document.querySelector('.breadths');
    const reqs = document.querySelector('.reqs');
    const genEds = document.querySelector('.genEds');
    const classlvl = document.querySelector('.classlvl');
    const sub = document.querySelector('.sub-1');

  menuButton.addEventListener('click', function () {
    const isVisible = credits.style.display === 'block';
    credits.style.display = isVisible ? 'none' : 'block';
    breadths.style.display = isVisible ? 'none' : 'block';
    reqs.style.display = isVisible ? 'none' : 'block';
    genEds.style.display = isVisible ? 'none' : 'block';
    classlvl.style.display = isVisible ? 'none' : 'block';
    sub.style.height = isVisible ? '100%' : '50vh';
  });
});
</script>
<script>
// check if mobile


    document.addEventListener('htmx:afterOnLoad', function(event) {
    if (event.detail.target.id === 'class_info' && window.innerWidth < 1200) {
        document.getElementsByClassName('sub-1')[0].style.display = 'none';
        document.getElementsByClassName('sub-2')[0].style.display = 'none';
        document.getElementsByClassName('sub-3')[0].style.display = 'block';
    }
});

function goBack() {
    if (window.innerWidth < 1200) {
        document.getElementsByClassName('sub-1')[0].style.display = 'block';
        document.getElementsByClassName('sub-2')[0].style.display = 'block';
        document.getElementsByClassName('sub-3')[0].style.display = 'none';
    }
}
</script>

</html>
